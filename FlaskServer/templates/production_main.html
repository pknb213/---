{% extends 'main_base.html' %}
{% block head %}
<script>
    function winPop(url, opts) {
        var popupName = opts.name || 'popup';
        var options = '';
        options += 'width=' + (opts.width ? opts.width : 200) + ', height=' + (opts.height ? opts.height : 200);
        options += opts.left && opts.width ? ', left=' + opts.left : ', left=' + ((screen.availWidth - opts.width) / 2);
        options += opts.top && opts.height ? ', top=' + opts.top : ', top=' + ((screen.availHeight - opts.height) / 2);
        options += opts.scrollbars ? ', scrollbars=' + opts.scrollbars : ', scrollbars=no';
        options += opts.resizable ? ', resizable=' + opts.resizable : ', resizable=no';
        console.log(popupName);
        window.open(url, popupName, options);
    }

    function JSON_parse_convertor(string) {
        string = string.replace(/'/gi, '"');
        string = string.replace(/ObjectId\(/gi, '');
        string = string.replace(/\)/gi, '');
        string = JSON.parse(string);

        return string;
    }

    function model_filter() {
        var table_rows = $('#main_table_list').val();
        console.log(table_rows);
        if (table_rows == undefined) {
            console.log('Table length is empty');
        } else {
            table_rows = JSON_parse_convertor(table_rows);
            var model_list = new Array();
            for (var i = 0; i < table_rows.length; i++) {
                model_list[i] = table_rows[i]['model'];
            }
            console.log(model_list);
            /*
            var uniq = model_list.slice().sort(function (a, b) {   // 복사본 만듬
                return a - b;
            })
                .reduce(function (a, b) {
                    if (a.slice(-1)[0] != b) a.push(b);  // slice(-1)[0]을 통해 마지막 아이템 가져온다
                    return a;
                }, []); // a가 시작될 때를 위한 비어있는 배열
            */
            $('#model_filter option').each(function () {
                $('#model_filter').append(
                    $('<option>').append(model_list)
                )
            });

        }
    }

    function location_filter() {
        $('#location_filter').append(
            $('<option>').append(1),
            $('<option>').append(2),
            $('<option>').append(3)
        );

    }

    function state_filter() {
        $('#state_filter').append(
            $('<option>').append(1),
            $('<option>').append(2),
            $('<option>').append(3)
        );

    }

    function main_table() {
        var specific_date_row = $('#specific_date_list').val();
        console.log("Date serch? : " + specific_date_row);
        var table_rows = $('#main_table_list').val();
        console.log(table_rows);
        if (specific_date_row != undefined && specific_date_row != 'None') {
            console.log("Specific date search");
            specific_date_row = JSON_parse_convertor(specific_date_row);
            for (var i = 0; i < specific_date_row[0].length; i++) {
                $('#main_table').append(
                    $('<tr>').append(
                        //$('<td><input type="checkbox" name="main_checkbox"/>').append(specific_date_row[1][i]['model']),
                        //$('<td>').append(specific_date_row[2][i]['location_history'][specific_date_row[2][i]['location_history'].length - 1]['location']),
                        $('<td>').append(specific_date_row[1][i]['model']),
                        $('<td>').append(specific_date_row[0][i]['sn']),
                        $('<td>').append(specific_date_row[0][i]['week']),
                        $('<td>').append(specific_date_row[2][i]['location']),
                        $('<td>').append(specific_date_row[2][i]['state']),
                        $('<td><button type="button" id="detail_btn" name="detail_btn" value="" class="detail_btn_class btn btn-warning" data-toggle="modal" data-target="#detail_modal">자세히</button>')
                    )
                );
                document.getElementsByName("detail_btn")[i].value = specific_date_row[2][i]['product_info_id'];
            }
        } else if (table_rows == undefined) {
            console.log('Table length is empty');
        } else {
            table_rows = JSON_parse_convertor(table_rows);
            for (var i = 0; i < table_rows.length; i++) {
                $('#main_table').append(
                    $('<tr>').append(
                        //$('<td><input type="checkbox" name="main_checkbox"/>').append(model_row[i]['model']),
                        $('<td>').append(table_rows[i]['model']),
                        $('<td>').append(table_rows[i]['sn']),
                        $('<td>').append(table_rows[i]['week']),
                        $('<td>').append(table_rows[i]['location']),
                        $('<td>').append(table_rows[i]['state']),
                        $('<td><button type="button" id="detail_btn" name="detail_btn" value="" class="detail_btn_class btn btn-warning" data-toggle="modal" data-target="#detail_modal">자세히</button>')
                    )
                );
                document.getElementsByName("detail_btn")[i].value = table_rows[i]['product_info_id'];
            }
        }
    }

    function state_change_table() {
        var table_rows = $('#main_table_list').val();
        console.log(table_rows);
        if (table_rows == undefined) {
            console.log("main_table_list is Empty");
        } else {
            table_rows = JSON_parse_convertor(table_rows);
            for (var i = 0; i < table_rows.length; i++) {
                $('#state_table').append(
                    $('<tr>').append(
                        $('<td><input class="checkbox" type="checkbox" name="check_box" value=""/>').append(table_rows[i]['model']),
                        $('<input type="hidden" name="id" value="">'),
                        $('<td>').append(table_rows[i]['sn']),
                        $('<td><input type="text" class="form-control" name="location" value="" >'),
                        $('<td><select class="form-control" name="reason" id="reason" value="">' +
                            '<option>신규생산</option>' +
                            '<option>판매</option>' +
                            '<option>기증</option>' +
                            '<option>내수용</option>' +
                            '<option>A/S</option>' +
                            '<option>불량</option>' +
                            '<option>반납</option>' +
                            '<option>이동</option>' +
                            '</select>')
                    )
                );
                //$("#state option:eq(i)").attr("selected", "selected");
                document.getElementsByName("check_box")[i].value = table_rows[i]['product_info_id'];
                document.getElementsByName("id")[i].value = table_rows[i]['product_info_id'];
                document.getElementsByName("location")[i].value = table_rows[i]['location'];
                document.getElementsByName("reason")[i].value = table_rows[i]['reason'];
            }
        }
    }

    // 나중에 행 추가, 삭제 기능
    function insert_table() {
        $('#insert_table').append(
            $('<tr>').append(
                $('<td><select class="form-control" id="insert_model" name="model">' +
                    '<option>Indy3</option>\n' +
                    '<option>Indy5</option>\n' +
                    '<option>Indy7</option>\n' +
                    '<option>Opti</option>\n' +
                    '<option>Step-pc2</option>\n' +
                    '<option>Core</option>\n' +
                    '<option>Conty</option>\n' +
                    '</select>'),
                $('<td><input type="text" class="form-control" id="insert_sn" name="sn">'),
                $('<td><input type="text" class="form-control" id="insert_header" name="header">')
            )
        );
    }

    function detail_tabler() {
        $(".detail_btn_class").click(function () {
            // Table initialization
            $('#detail_table > tbody:last').empty();
            $('#detail_info > tbody:last').empty();

            var product_row = $('#model_list').val();
            var product_info_row = $('#info_list').val();
            var history_row = $('#history_list').val();
            var received_id = $(this).val();
            var _date = new Array();
            var _location = new Array();
            var _state = new Array();
            var _week = new Array();
            var _reason = new Array();
            product_row = JSON_parse_convertor(product_row);
            product_info_row = JSON_parse_convertor(product_info_row);
            history_row = JSON_parse_convertor(history_row);
            var _model, _sn, _header, _model_id;
            for (var j = 0; j < history_row.length; j++) {
                if (received_id == history_row[j]['product_id']) {
                    _date.push(history_row[j]['date']);
                    _location.push(history_row[j]['location']);
                    _state.push(history_row[j]['state']);
                    _reason.push(history_row[j]['reason']);
                }
            }
            for (var k = 0; k < product_info_row.length; k++) {
                if (received_id == product_info_row[k]['_id']) {
                    _model_id = product_info_row[k]['model_id'];
                    _sn = product_info_row[k]['sn'];
                    _week = product_info_row[k]['week'];
                    _header = product_info_row[k]['header'];
                    for (var p = 0; p < product_row.length; p++) {
                        if (_model_id == product_row[p]['_id']) {
                            _model = product_row[p]['model'];
                        }
                    }
                }
            }
            //console.log(_date);
            //console.log(_location);
            //console.log(_state);
            if (product_info_row.length != product_info_row.length) {
                alert("DB Length is wrong !");
            }
            $('#detail_info').append(
                $('<tr>').append(
                    $('<th class="text-right">').append("Model:  " + _model),
                    $('<th class="text-right">').append("SN:  " + _sn),
                    $('<th class="text-right">').append("생산 Week:  " + _week),
                    $('<th class="text-right">').append("Header:  " + _header)
                )
            );
            for (var i = 0; i < _date.length; i++) {
                $('#detail_table').append(
                    $('<tr>').append(
                        $('<td>').append(_date[i]),
                        $('<td>').append(_location[i]),
                        $('<td>').append(_state[i]),
                        $('<td>').append(_reason[i]))
                );
            }
        });
    }

    function btn_click_event() {
        $("#state_filter").click(function () {
            alert('hi');
            var rowData = new Array();
            var tdArr = new Array();
            var checkbox = $("input[name=main_checkbox]:checked");

            // 체크된 체크박스 값을 가져온다
            checkbox.each(function (i) {
                // checkbox.parent() : checkbox의 부모는 <td>이다.
                // checkbox.parent().parent() : <td>의 부모이므로 <tr>이다.
                var tr = checkbox.parent().parent().eq(i);
                var td = tr.children();

                // 체크된 row의 모든 값을 배열에 담는다.
                rowData.push(tr.text());

                // td.eq(0)은 체크박스 이므로  td.eq(1)의 값부터 가져온다.
                var no = td.eq(0).text() + ", "
                var userid = td.eq(1).text() + ", ";
                var name = td.eq(2).text() + ", ";
                var email = td.eq(3).text() + ", ";

                // 가져온 값을 배열에 담는다.
                tdArr.push(no);
                tdArr.push(userid);
                tdArr.push(name);
                tdArr.push(email);
            });

            $("#ex3_Result1").html(" * 체크된 Row의 모든 데이터 = " + rowData);
            $("#ex3_Result2").html(tdArr);
        });
    }

    // As Jquery same the [ window.onload = function(){} ]
    $(document).ready(function () {
        main_table();
        btn_click_event();
        state_change_table();
        detail_tabler();
        insert_table();
        model_filter();
        location_filter();
        state_filter();
        $('#state_submit_btn').click(function () {
            if ($('#state').val().length == 0) {
                alert("빈 칸을 입력하세요");
                $('#state').focus();
                return false;
            }
        });
        $('#insert_submit_btn').click(function () {
            if ($('#insert_sn').val().length == 0) {
                alert("빈 칸을 입력하세요");
                $('#insert_sn').focus();
                return false;
            }
            if ($('#insert_header').val().length == 0) {
                alert("빈 칸을 입력하세요");
                $('#insert_header').focus();
                return false;
            }
        });
    });

</script>
{% endblock %}
{% block title %} 재고관리 페이지 {% endblock %}
{% block body_title %}Title{% endblock %}
{% block main_title %}재고관리 화면{% endblock %}
{% block body %}
<form class="form-inline" action="/search" method="POST">
    <div class="row container-fluid">
        <input type="date" name="startDate" value={{object.date()}} class="col-2 btn-primary">
        <input type="date" name="endDate" value={{object.date()}} class="col-2 btn-primary date_box">
        <input type="hidden" name="page" value="p_page"/>
        <button type="submit" class="btn col-1 btn-warning">검색</button>
    </div>
</form>
<hr/>
<form class="form-inline" action="/" method="POST">
    <div class="row container-fluid">
        <!--<button type="button" class="btn btn-primary col-1" onclick="location.href='/all_collection'">전체</button>-->
        <button type="button" class="btn btn-primary col-1" onclick="location.href='/'">전체</button>
        <select id="model_filter" class="btn btn-primary col-1" value="">
            <option hidden>모델 필터</option>
        </select>
        <select id="location_filter" class="btn btn-primary col-1" value="">
            <option hidden>위치 필터</option>
            <option></option>
            <option></option>
        </select>
        <select id="state_filter" class="btn btn-primary col-1" value="">
            <option hidden>상태 필터</option>
            <option></option>
            <option></option>
        </select>
        <button type="submit" id="submit_filter" class="btn btn-warning col-1">필터 적용</button>
        <a href="/insert_plan" class="btn btn-warning col-1 offset-2"
           onclick="winPop(this.href, {name:'insert_excel',width:1500,height:800}); return false;">생산계획입력 </a>
        <button type="button" class="btn btn-warning col-1 " data-toggle="modal" data-target="#shipment_modal">상태 변경
        </button>
        <button type="button" class="btn btn-warning col-1" data-toggle="modal" data-target="#insert_modal"> 등록</button>
    </div>
</form>
<hr/>
{% if object.production_main_model()[0] %}
<input hidden id="info_list" value="{{ object.production_main_info_list() }}"/>
<input hidden id="model_list" value="{{ object.production_main_model() }}"/>
<input hidden id="history_list" value="{{ object.production_main_history() }}"/>
<input hidden id="specific_date_list" value="{{ date_rows }}"/>
<input hidden id="main_table_list" value="{{ object.main_table_rows() }}"/>
<table class="table table-striped table-bordered" id="main_table">
    <thead class="thead-dark">
    <tr>
        <th>모델명</th>
        <th>시리얼 넘버</th>
        <th>생산 주차</th>
        <th>위치</th>
        <th>상태</th>
        <th>추적</th>
    </tr>
    </thead>
    <tbody>
    <!--  Call of the Java Script Function (table) -->
    </tbody>
</table>
{% else %}
<h3> No Notice in the Database</h3>
{% endif %}
</div>
<hr>
<div class="col-lg-12" id="ex3_Result1"></div>
<div class="col-lg-12" id="ex3_Result2"></div>
<!-- Test Part -->

<!-- The Product Insert Modal -->
<div class="modal fade" id="insert_modal">
    <div class="modal-dialog modal-lg">
        <form class="form-inline" action="/insert_data" method="POST" enctype=multipart/form-data>
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header text-white bg-secondary">
                    <h1 class="page-header">등 록</h1>
                </div>
                <!-- Modal Body -->
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="insert_table">
                            <thead class="thead-dark">
                            <tr>
                                <th>모델명</th>
                                <th>시리얼넘버</th>
                                <th>담당자</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="submit" id="insert_submit_btn" class="btn btn-warning">확 인
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- Modify State The Modal -->
<div class="modal fade" id="shipment_modal">
    <div class="modal-dialog modal-lg">
        <form class="form-inline" action="/state_change" method="POST" enctype=multipart/form-data>
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header text-white bg-secondary">
                    <h1 class="page-header">상태 변경 화면</h1>
                </div>
                <!-- Modal Body -->
                <div class="modal-body">
                    <div class="table-responsive">
                        {% if object.production_main_model()[0] %}
                        <table class="table table-striped table-bordered" id="state_table">
                            <thead class="thead-dark">
                            <tr>
                                <th>모델명</th>
                                <th>시리얼 넘버</th>
                                <th>위치</th>
                                <th>사유</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!--  Call of the Java Script Function (table) -->
                            </tbody>
                        </table>
                        {% else %}
                        <h3> No Notice in the CheckBox</h3>
                        <input type="hidden" id="state_submit_btn" name="data_empty" value='{{ true }}'/>
                        {% endif %}
                    </div>
                </div>
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">확 인
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- The Detail Console Modal -->
<div class="modal fade" id="detail_modal">
    <div class="modal-dialog modal-lg">

        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header text-white bg-secondary table-responsive">
                <table class="table table-borderless" id="detail_info">
                    <thead>
                    <tr>
                        <th><h1>상세 화면</h1></th>
                    </tr>
                    </thead>
                    <tbody>
                            <!--  Call of the Java Script Function (table) -->
                        </tbody>
                </table>
            </div>
            <!-- Modal Body -->
            <div class="modal-body">
                {% if object.production_main_info_list()[0] %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="detail_table">
                        <thead class="thead-dark">
                        <tr>
                            <th>날짜</th>
                            <th>위치</th>
                            <th>상태</th>
                            <th>비고(사유)</th>
                        </tr>
                        </thead>
                        <tbody>
                            <!--  Call of the Java Script Function (table) -->
                            </tbody>
                    </table>
                    {% else %}
                    <h3> No Notice in the CheckBox</h3>
                    <input type="hidden" name="data_empty" value='{{ true }}'/>
                    {% endif %}
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" data-dismiss="modal">확 인
                </button>
            </div>
        </div>

    </div>
</div>
{% endblock %}
